<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nexis Chat</title>

<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#0f0f14;color:white}
header{padding:16px;text-align:center;font-weight:600;font-size:20px;background:#111}
.container{padding:16px}
input,button{padding:10px;border:none;border-radius:8px;font-size:14px}
button{background:#5b7cff;color:white}
.hidden{display:none}
#chat{height:55vh;overflow-y:auto;margin:12px 0}
.msg{padding:8px 12px;margin:2px 0;border-radius:12px;max-width:75%;word-break:break-word}
.me{background:#5b7cff;margin-left:auto}
.other{background:#2a2a35}
.row{display:flex;gap:8px;align-items:center}
.friend{padding:10px;margin:6px 0;background:#1a1a22;border-radius:8px}
.small{font-size:11px;opacity:0.6}
.nameLabel{font-size:11px;opacity:0.6;margin-bottom:2px}
a{color:#8ab4ff;text-decoration:none}
</style>
</head>
<body>

<header>Nexis Chat</header>
<div class="container">

<div id="setup">
  <h3>åˆæœŸè¨­å®š</h3>
  <input id="nameInput" placeholder="ã‚ãªãŸã®åå‰">
  <button onclick="saveName()">ä¿å­˜</button>
</div>

<div id="app" class="hidden">

<!-- ===== å‹é”ç”»é¢ ===== -->
<div id="friendsScreen">

  <div class="row">
    <div>
      <div class="small">ã‚ãªãŸã®QR</div>
      <div id="qr"></div>
    </div>
    <img src="setumei.gif" width="120" style="margin-left:12px;border-radius:8px">
  </div>

  <hr>

  <div class="row">
    <input id="friendIdInput" placeholder="å‹é”IDã‚’è²¼ã‚Šä»˜ã‘" style="flex:1">
    <button onclick="manualConnect()">æ¥ç¶š</button>
  </div>

  <button onclick="openFileDrop()" style="margin-top:12px;width:100%;background:#9b5cff">
    ğŸ“ Nexis FileDrop ã‚’é–‹ã
  </button>

  <h4>å‹é”</h4>
  <div id="friendList"></div>
</div>

<!-- ===== ãƒãƒ£ãƒƒãƒˆç”»é¢ ===== -->
<div id="chatScreen" class="hidden">
  <button onclick="goFriends()" style="background:#2a2a35">â† æˆ»ã‚‹</button>
  <h3 id="chatTitle"></h3>

  <div id="chat"></div>

  <div class="row">
    <input id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" style="flex:1">
    <button onclick="sendMsg()">é€ä¿¡</button>
  </div>

  <button onclick="deleteFriend()" style="margin-top:10px;background:#ff4d4d">
    å‹é”ã‚’å‰Šé™¤
  </button>
</div>

</div>
</div>

<script>
const API_KEY="YOUR_ABLY_API_KEY";

let myName=localStorage.getItem("nexis_name");
let myId=localStorage.getItem("nexis_id");
let friends=JSON.parse(localStorage.getItem("nexis_friends")||"{}");
let currentFriend=null;
let ably;

if(!myId){
  myId=crypto.randomUUID();
  localStorage.setItem("nexis_id",myId);
}

if(myName){ init(); }
else{ document.getElementById("setup").style.display="block"; }

function saveName(){
  const name=document.getElementById("nameInput").value.trim();
  if(!name) return;
  localStorage.setItem("nexis_name",name);
  myName=name;
  init();
}

function init(){
  document.getElementById("setup").style.display="none";
  document.getElementById("app").classList.remove("hidden");

  new QRCode(document.getElementById("qr"),myId);

  ably=new Ably.Realtime(API_KEY);

  const inbox=ably.channels.get("inbox-"+myId);
  inbox.subscribe(msg=>{
    const d=msg.data;
    autoAddFriend(d.sender,d.senderName);
    saveHistory(d.sender,d,false);
    if(currentFriend===d.sender){
      addMessage(d.text,false,d.senderName);
    }
  });

  renderFriends();
}

function manualConnect(){
  const id=document.getElementById("friendIdInput").value.trim();
  if(!id) return;
  autoAddFriend(id,"Unknown");
  document.getElementById("friendIdInput").value="";
}

function autoAddFriend(id,name){
  if(!friends[id]){
    friends[id]={name:name||"Unknown"};
    localStorage.setItem("nexis_friends",JSON.stringify(friends));
    renderFriends();
  }else if(name && friends[id].name==="Unknown"){
    friends[id].name=name;
    localStorage.setItem("nexis_friends",JSON.stringify(friends));
    renderFriends();
  }
}

function renderFriends(){
  const list=document.getElementById("friendList");
  list.innerHTML="";
  Object.keys(friends).forEach(id=>{
    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${friends[id].name}</strong>
      <div class="small">${id.slice(0,8)}...</div>
      <button onclick="openChat('${id}')">ãƒãƒ£ãƒƒãƒˆ</button>
    `;
    list.appendChild(div);
  });
}

function openChat(id){
  currentFriend=id;
  document.getElementById("friendsScreen").classList.add("hidden");
  document.getElementById("chatScreen").classList.remove("hidden");
  document.getElementById("chatTitle").innerText=friends[id].name;
  document.getElementById("chat").innerHTML="";
  loadHistory(id);
}

function goFriends(){
  currentFriend=null;
  document.getElementById("chatScreen").classList.add("hidden");
  document.getElementById("friendsScreen").classList.remove("hidden");
}

function sendMsg(){
  const input=document.getElementById("msgInput");
  const text=input.value.trim();
  if(!text||!currentFriend) return;

  const payload={
    sender:myId,
    senderName:myName,
    text:text
  };

  ably.channels.get("inbox-"+currentFriend).publish("message",payload);

  saveHistory(currentFriend,payload,true);
  addMessage(text,true,myName);
  input.value="";
}

function addMessage(text,mine,name){
  const wrapper=document.createElement("div");

  const label=document.createElement("div");
  label.className="nameLabel";
  label.innerText=name;

  const bubble=document.createElement("div");
  bubble.className="msg "+(mine?"me":"other");
  bubble.innerHTML=autoLink(text);

  wrapper.appendChild(label);
  wrapper.appendChild(bubble);

  document.getElementById("chat").appendChild(wrapper);
  document.getElementById("chat").scrollTop=999999;
}

function autoLink(text){
  const urlRegex=/((https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w-./?%&=]*)?)/g;
  return text.replace(urlRegex,function(url){
    let link=url;
    if(!url.startsWith("http")) link="https://"+url;
    return `<a href="${link}" target="_blank">${url}</a>`;
  });
}

function saveHistory(friend,data,mine){
  let history=JSON.parse(localStorage.getItem("chat_"+friend)||"[]");
  history.push({text:data.text,mine:mine,name:data.senderName});
  localStorage.setItem("chat_"+friend,JSON.stringify(history));
}

function loadHistory(friend){
  let history=JSON.parse(localStorage.getItem("chat_"+friend)||"[]");
  history.forEach(m=>addMessage(m.text,m.mine,m.name));
}

function deleteFriend(){
  if(!currentFriend) return;
  if(confirm("ã“ã®å‹é”ã¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    delete friends[currentFriend];
    localStorage.removeItem("chat_"+currentFriend);
    localStorage.setItem("nexis_friends",JSON.stringify(friends));
    goFriends();
    renderFriends();
  }
}

function openFileDrop(){
  window.location.href="https://ayatocraft.github.io/NexisFileDrop";
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
