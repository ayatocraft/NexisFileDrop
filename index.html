<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nexis FileDrop</title>
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#0f0f14;color:white}
header{padding:16px;text-align:center;font-weight:600;font-size:20px;background:#111}
.container{padding:16px}
input,button{padding:10px;border:none;border-radius:8px;margin-top:8px}
button{background:linear-gradient(45deg,#6a5cff,#9b5cff);color:white}
.hidden{display:none}
#log,#progress{margin-top:12px;font-size:12px;opacity:.8}
.box{background:#1a1a22;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;line-height:1.6}
.success{color:#5cff9b}
</style>
</head>
<body>

<header>Nexis FileDrop</header>

<div class="container">

<div class="box">
<b>ä½¿ã„æ–¹</b><br>
â‘  Chatã‹ã‚‰ã€Œã“ã®å‹é”ã«FileDropã€ã‚’æŠ¼ã™<br>
â‘¡ è‡ªå‹•æ¥ç¶šã•ã‚Œã¾ã™<br>
â‘¢ ã©ã¡ã‚‰ã‹ãŒã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€<br>
â‘£ ç›¸æ‰‹å´ã¯è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰<br>
â€» 1å¯¾1ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€ä¿¡ã§ã™
</div>

<input id="friendIdInput" placeholder="ç›¸æ‰‹ã®ID" style="width:100%">
<button onclick="startConnection()">æ¥ç¶š</button>
<button onclick="selectFile()">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
<input type="file" id="fileInput" class="hidden">

<div id="progress"></div>
<div id="log"></div>

</div>

<script>
const API_KEY="JW3Hvw.fw1o0A:-zV3VatQkBUx-hVmtwFGE6Bwbv_wG4kIoz7LHOKNawY";

let myId=localStorage.getItem("nexis_id");
if(!myId){
  myId=crypto.randomUUID();
  localStorage.setItem("nexis_id",myId);
}

let ably=new Ably.Realtime(API_KEY);
let peer=null;
let dataChannel=null;
let channel=null;

function log(t,className=""){
  const el=document.getElementById("log");
  el.className=className;
  el.innerText=t;
}

function startConnection(){

  const friend=document.getElementById("friendIdInput").value.trim();
  if(!friend) return alert("IDã‚’å…¥åŠ›");

  const room=[myId,friend].sort().join("-");
  channel=ably.channels.get("file-"+room);

  peer=new RTCPeerConnection({
    iceServers:[{urls:"stun:stun.l.google.com:19302"}]
  });

  peer.onicecandidate=e=>{
    if(e.candidate){
      channel.publish("signal",{candidate:e.candidate});
    }
  };

  channel.subscribe("signal",async msg=>{
    const d=msg.data;

    if(d.offer){
      await peer.setRemoteDescription(d.offer);
      const answer=await peer.createAnswer();
      await peer.setLocalDescription(answer);
      channel.publish("signal",{answer:answer});
    }

    if(d.answer){
      await peer.setRemoteDescription(d.answer);
    }

    if(d.candidate){
      try{ await peer.addIceCandidate(d.candidate);}catch{}
    }
  });

  if(myId < friend){
    dataChannel=peer.createDataChannel("file");
    setupChannel();

    peer.createOffer().then(o=>{
      peer.setLocalDescription(o);
      channel.publish("signal",{offer:o});
    });

  }else{
    peer.ondatachannel=e=>{
      dataChannel=e.channel;
      setupChannel();
    };
  }

  log("æ¥ç¶šä¸­...");
}

function setupChannel(){

  dataChannel.onopen=()=>{
    log("æ¥ç¶šæˆåŠŸ", "success");
  };

  let currentFile;
  let receivedBuffers=[];
  let receivedSize=0;

  dataChannel.onmessage=e=>{
    if(typeof e.data==="string"){
      currentFile=JSON.parse(e.data);
      receivedBuffers=[];
      receivedSize=0;
    }else{
      receivedBuffers.push(e.data);
      receivedSize+=e.data.byteLength;

      document.getElementById("progress").innerText=
        Math.floor(receivedSize/currentFile.size*100)+"%";

      if(receivedSize===currentFile.size){
        const blob=new Blob(receivedBuffers);
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=currentFile.name;
        a.click();
        log("å—ä¿¡å®Œäº†", "success");
      }
    }
  };
}

function selectFile(){
  document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file || !dataChannel || dataChannel.readyState!=="open"){
    return alert("æ¥ç¶šãŒå¿…è¦");
  }

  dataChannel.send(JSON.stringify({name:file.name,size:file.size}));

  const chunkSize=16384;
  let offset=0;
  const reader=new FileReader();

  reader.onload=e=>{
    dataChannel.send(e.target.result);
    offset+=e.target.result.byteLength;

    document.getElementById("progress").innerText=
      Math.floor(offset/file.size*100)+"%";

    if(offset<file.size){
      readSlice(offset);
    }else{
      log("é€ä¿¡å®Œäº†", "success");
    }
  };

  function readSlice(o){
    reader.readAsArrayBuffer(file.slice(o,o+chunkSize));
  }

  readSlice(0);
});

// ğŸ”¥ Chatã‹ã‚‰ã®è‡ªå‹•å…¥åŠ›å¯¾å¿œï¼ˆç¢ºå®Ÿç‰ˆï¼‰
window.addEventListener("load",()=>{
  const params=new URLSearchParams(window.location.search);
  const auto=params.get("to");

  if(auto){
    document.getElementById("friendIdInput").value=auto;

    // Ablyæ¥ç¶šå¾…ã¡
    ably.connection.once("connected",()=>{
      setTimeout(()=>startConnection(),500);
    });
  }
});
</script>

</body>
</html>
