<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nexis FileDrop</title>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#0f0f14;
  color:white;
  text-align:center;
  padding:20px;
}
h1{margin-bottom:10px}
.card{
  background:#1a1a22;
  padding:20px;
  border-radius:12px;
  margin:15px auto;
  max-width:400px;
}
input,button{
  padding:10px;
  border:none;
  border-radius:8px;
  font-size:14px;
}
input{
  width:70%;
}
button{
  background:#5b7cff;
  color:white;
  cursor:pointer;
}
button:disabled{
  opacity:0.5;
}
.status{
  font-size:13px;
  opacity:0.7;
  margin-top:10px;
}
</style>
</head>
<body>

<h1>Nexis FileDrop</h1>

<div class="card">
  <div><strong>あなたのID</strong></div>
  <div id="myId">生成中...</div>
</div>

<div class="card">
  <div><strong>接続先ID</strong></div>
  <input id="peerIdInput" placeholder="相手のID">
  <button onclick="connectPeer()">接続</button>
  <div class="status" id="connStatus">未接続</div>
</div>

<div class="card">
  <div><strong>ファイル送信</strong></div>
  <input type="file" id="fileInput">
  <br><br>
  <button onclick="sendFile()" id="sendBtn" disabled>送信</button>
  <div class="status" id="fileStatus"></div>
</div>

<script>
let peer;
let conn;
let myId;
let connected=false;

// URLパラメータ取得（自動入力のみ）
const params = new URLSearchParams(location.search);
const autoTo = params.get("to");

if(autoTo){
  document.getElementById("peerIdInput").value = autoTo;
}

// Peer初期化（デフォルトサーバー）
peer = new Peer();

peer.on("open", id=>{
  myId=id;
  document.getElementById("myId").innerText=id;
});

peer.on("connection", connection=>{
  conn=connection;
  setupConnection();
});

function connectPeer(){
  const target=document.getElementById("peerIdInput").value.trim();
  if(!target) return;

  conn=peer.connect(target);
  setupConnection();
}

function setupConnection(){
  document.getElementById("connStatus").innerText="接続中...";

  conn.on("open", ()=>{
    connected=true;
    document.getElementById("connStatus").innerText="接続済み";
    document.getElementById("sendBtn").disabled=false;
  });

  conn.on("data", data=>{
    if(data.type==="file"){
      receiveFile(data);
    }
  });

  conn.on("close", ()=>{
    connected=false;
    document.getElementById("connStatus").innerText="切断";
    document.getElementById("sendBtn").disabled=true;
  });
}

function sendFile(){
  if(!connected) return;

  const file=document.getElementById("fileInput").files[0];
  if(!file) return;

  const reader=new FileReader();

  reader.onload=()=>{
    conn.send({
      type:"file",
      name:file.name,
      data:reader.result
    });
    document.getElementById("fileStatus").innerText="送信完了";
  };

  reader.readAsDataURL(file);
}

function receiveFile(data){
  const a=document.createElement("a");
  a.href=data.data;
  a.download=data.name;
  a.click();

  document.getElementById("fileStatus").innerText=
    "受信: "+data.name;
}
</script>

</body>
</html>
