<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nexis FileDrop</title>
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0f14">

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#0f0f14;color:white}
header{padding:16px;text-align:center;font-weight:600;font-size:20px;background:#111}
.container{padding:16px}
input,button{padding:10px;border:none;border-radius:8px}
button{background:linear-gradient(45deg,#6a5cff,#9b5cff);color:white}
.hidden{display:none}
#log,#progress{margin-top:12px;font-size:12px;opacity:.7}
</style>
</head>
<body>

<header>Nexis FileDrop</header>
<div class="container">

<input id="friendIdInput" placeholder="相手のID" style="width:100%">
<button onclick="startConnection()">接続</button>
<button onclick="selectFile()">ファイル選択</button>

<input type="file" id="fileInput" class="hidden">

<div id="progress"></div>
<div id="log"></div>

</div>

<script>
const params=new URLSearchParams(location.search);
const autoFriend=params.get("to");

if(autoFriend){
  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("friendIdInput").value=autoFriend;
    setTimeout(()=>startConnection(),500);
  });
}
const API_KEY="JW3Hvw.fw1o0A:-zV3VatQkBUx-hVmtwFGE6Bwbv_wG4kIoz7LHOKNawY";

let myId=localStorage.getItem("nexis_id");
if(!myId){
  myId=crypto.randomUUID();
  localStorage.setItem("nexis_id",myId);
}

let ably=new Ably.Realtime(API_KEY);
let peer,dataChannel,currentFile;
let receivedBuffers=[],receivedSize=0;

const params=new URLSearchParams(location.search);
const autoFriend=params.get("to");
if(autoFriend){
  document.getElementById("friendIdInput").value=autoFriend;
  setTimeout(()=>startConnection(),500);
}

function log(t){document.getElementById("log").innerText=t;}

function startConnection(){
  const friend=document.getElementById("friendIdInput").value.trim();
  if(!friend)return;

  const room=[myId,friend].sort().join("-");
  const channel=ably.channels.get("file-"+room);

  peer=new RTCPeerConnection();
  dataChannel=peer.createDataChannel("file");
  setupDataChannel();

  peer.onicecandidate=e=>{
    if(e.candidate){
      channel.publish("signal",{candidate:e.candidate});
    }
  };

  channel.subscribe(async msg=>{
    const d=msg.data;
    if(d.offer){
      await peer.setRemoteDescription(d.offer);
      const ans=await peer.createAnswer();
      await peer.setLocalDescription(ans);
      channel.publish("signal",{answer:ans});
    }
    if(d.answer) await peer.setRemoteDescription(d.answer);
    if(d.candidate) try{await peer.addIceCandidate(d.candidate);}catch{}
  });

  peer.ondatachannel=e=>{
    dataChannel=e.channel;
    setupDataChannel();
  };

  peer.createOffer().then(o=>{
    peer.setLocalDescription(o);
    channel.publish("signal",{offer:o});
  });

  log("接続中...");
}

function setupDataChannel(){
  dataChannel.onopen=()=>log("接続成功");

  dataChannel.onmessage=e=>{
    if(typeof e.data==="string"){
      currentFile=JSON.parse(e.data);
      receivedBuffers=[];
      receivedSize=0;
    }else{
      receivedBuffers.push(e.data);
      receivedSize+=e.data.byteLength;
      document.getElementById("progress").innerText=
        Math.floor(receivedSize/currentFile.size*100)+"%";
      if(receivedSize===currentFile.size){
        const blob=new Blob(receivedBuffers);
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=currentFile.name;
        a.click();
        log("受信完了");
      }
    }
  };
}

function selectFile(){
  document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file||!dataChannel||dataChannel.readyState!=="open"){
    alert("接続が必要");
    return;
  }

  dataChannel.send(JSON.stringify({name:file.name,size:file.size}));

  const chunkSize=16384;
  let offset=0;
  const reader=new FileReader();

  reader.onload=e=>{
    dataChannel.send(e.target.result);
    offset+=e.target.result.byteLength;
    document.getElementById("progress").innerText=
      Math.floor(offset/file.size*100)+"%";
    if(offset<file.size){
      readSlice(offset);
    }else{
      log("送信完了");
    }
  };

  function readSlice(o){
    const slice=file.slice(o,o+chunkSize);
    reader.readAsArrayBuffer(slice);
  }

  readSlice(0);
});

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
